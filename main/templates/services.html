{% extends 'base.html' %}
{% load static %}


{% block title %} Services: SHADAI {% endblock %}

{% block body %}
<nav class="navbar">
    <div class="nav-container">
        <a href="{% url 'home' %}" class="logo">
            <i class="fas fa-shield-halved"></i> SHAD<span>AI</span>
        </a>
    </div>
</nav>

<header class="hero">
    <div class="hero-content">
        <h1>Essayez gratuitement nos différents outils</h1>
    </div>
</header>
<main class="container services-page">

    <section id="gen" class="tool-card">
        <h2><i class="fas fa-key"></i> 1. Génération de Clés ECC</h2>
        <p class="tool-desc">Générez votre paire de clés asymétriques basées sur la courbe X25519.</p>
        <form id="submit_form_gen" action="{% url 'generate_keys' %}#gen" method="POST">
            {% csrf_token %}
            <button type="submit" id="submit_button_gen" class="btn">Générer les clés</button>
        </form>
        
        {% if public_key %}
        <div class="results-area">
            <div class="input-group">
                <label>Clé Publique (Partageable)</label>
                <div class="copy-box">
                    <input type="text" value="{{ public_key }}" id="pubKey" readonly>
                    <button onclick="copyToClipboard('pubKey')"><i class="fas fa-copy"></i></button>
                </div>
            </div>
            <div class="input-group">
                <label>Clé Privée (SECRET)</label>
                <div class="copy-box">
                    <input type="password" value="{{ private_key }}" id="privKey" readonly>
                    <button onclick="copyToClipboard('privKey')"><i class="fas fa-copy"></i></button>
                    <button onclick="toggleView('privKey')"><i class="fas fa-eye"></i></button>
                </div>
            </div>
            <p class="warning-msg">
                <i class="fas fa-exclamation-triangle"></i> Attention : Gardez votre clé 
                privée en lieu sûr. Elle ne pourra pas être récupérée si vous la perdez.
            </p>
        </div>
        {% endif %}
    </section>

    <section id="ecdh" class="tool-card">
        <h2><i class="fas fa-handshake"></i> 2. Calcul du Secret Partagé (ECDH)</h2>
        <form id="submit_form_ecdh" action="{% url 'compute_secret' %}#ecdh" method="POST">
            {% csrf_token %}
            <div class="input-group">
                <input type="text" name="my_private_key" placeholder="Votre clé privée" required>
            </div>
            <div class="input-group">
                <input type="text" name="peer_public_key" placeholder="Clé publique du destinataire" required>
            </div>
            <button type="submit" id="submit_button_ecdh" class="btn">Calculer le secret</button>
        </form>
        
        {% if shared_secret %}
        <div class="results-area">
            <div class="input-group">
                <label>Secret Partagé (Utilisez ceci comme clé de stéganographie)</label>
                <div class="copy-box">
                    <input type="text" value="{{ shared_secret }}" id="sharedSec" readonly class="grayed">
                    <button onclick="copyToClipboard('sharedSec')"><i class="fas fa-copy"></i></button>
                </div>
            </div>
            <p class="info-msg">Ce secret est identique pour vous et votre destinataire.</p>
            <p class="warning-msg">
                <i class="fas fa-exclamation-triangle"></i> Attention : Gardez cette clé sécrete en lieu sûr.
            </p>
        </div>
        {% elif ecdh_error %}
        <div class="results-area">
            <p class="error-msg"><i class="fas fa-ban"></i> {{ ecdh_error }}</p>
        </div>
        {% endif %}
    </section>

    <section id="stego" class="tool-card">
        <h2><i class="fas fa-file-export"></i> 3. Cacher un message (Encodage)</h2>
        <form id="submit_form_stego" action="{% url 'steganographier' %}#stego" method="POST" enctype="multipart/form-data" onsubmit="handleDownload()">
            {% csrf_token %}
            <div class="input-group">
                <label>Fichier image (.png, .jpg, .jpeg): Maximun 10Mo</label>
                <input type="file" name="file" accept="image/*" required>
            </div>
            <div class="input-group">
                <input type="text" name="secret_key" placeholder="Clé secrète (Secret partagé)" required>
            </div>
            <div class="input-group">
                <textarea name="message" placeholder="Votre message secret à cacher..." required></textarea>
            </div>
            <button type="submit" id="submit_button_stego" class="btn" onclick="alert('Le traitement va commencer ! Vérifiez vos téléchargements après.')">
                Stéganographier & Télécharger
            </button>
        </form>
        {% if stego_error %}
            <div class="results-area">
                <p class="error-msg"><i class="fas fa-ban"></i> {{ stego_error }}</p>
            </div>
        {% endif %}
    </section>

    <section id="anal" class="tool-card">
        <h2><i class="fas fa-search"></i> 4. Retrouver un message (Décodage)</h2>
        <form id="submit_form_anal" action="{% url 'steganalyser' %}#anal" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="input-group">
                <label>Fichier à analyser</label>
                <input type="file" name="file" accept="image/*" required>
            </div>
            <div class="input-group">
                <input type="text" name="secret_key" placeholder="Clé secrète de déchiffrement" required>
            </div>
            <button type="submit" id="submit_button_anal" class="btn">Steganalyser</button>
        </form>

        {% if anal_result %}
            <div class="alert {{ anal_status }}">
                {{ anal_result }}
            </div>
        {% endif %}
    </section>

    <section id="deep" class="tool-card">
        <h2><i class="fas fa-robot"></i> 5. Analyse Deepfake (IA)</h2>
        <form id="submit_form_deep" action="{% url 'detect_deepfake' %}#deep" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="input-group">
                <label>Image suspecte</label>
                <input type="file" name="file" accept="image/*" required>
            </div>
            <button type="submit" id="submit_button_deep" class="btn">Analyser l'authenticité</button>
        </form>

        {% if deepfake_result %}
            <div class="results-area deepfake-res">
                <h3>Résultat de l'analyse :</h3>
                <div class="percentage">{{ deepfake_score }}%</div>
                <p>{{ deepfake_result }}</p>
            </div>
        {% endif %}
    </section>

</main>

<script>
    function copyToClipboard(id) {
        var copyText = document.getElementById(id);
        copyText.select();
        document.execCommand("copy");
        alert("Copié dans le presse-papier !");
    }
    function toggleView(id) {
        var x = document.getElementById(id);
        if (x.type === "password") { x.type = "text"; } 
        else { x.type = "password"; }
    }
    function handleDownload() {
        // On attend un court instant (1 seconde) que le navigateur initie la requête
        // puis on recharge la page pour la réinitialiser
        setTimeout(function() {
            window.location.reload();
        }, 1000);
    }
    // Vérification de la taille du fichier côté client pour une meilleure expérience utilisateur(limitation à 10Mo)
    document.getElementById('submit_form_stego').addEventListener('submit', function(e) {
    const fileInput = document.querySelector('input[type="file"]');
    
    if (fileInput.files.length > 0) {
        const fileSize = fileInput.files[0].size / 1024 / 1024; // Conversion en Mo
        if (fileSize > 10) {
            alert("Le fichier est trop volumineux (Maximum 10 Mo).");
            e.preventDefault(); // Annule l'envoi du formulaire
        }
    }
});
</script>
{% endblock %}